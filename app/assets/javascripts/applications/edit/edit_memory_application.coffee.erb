#= require applications/memory_application
#= require applications/edit/portal_view
#= require applications/edit/sphere_select_view
#= require applications/edit/zoom_view

class EditMemoryApplication extends MemoryApplication
  constructor: (options = {}) ->
    super
    @portalView = new PortalView({ app: @ })
    @markerView = new MarkerView({ app: @ })
    @sphereSelectView = new SphereSelectView({ app: @ })
    @zoomView = new ZoomView({ app: @ })
    @addSphereView = new AddSphereView({ app: @ })
    @headerView = new HeaderView({ app: @ })

    @views = [@portalView, @markerView]

  bindHandlers: ->
    super
    PSV.off 'select-marker'

  start: ->
    super
    @hackThePencil()

# Helpers

  getPSVOptions: ->
    $.extend
      panorama: window.currentSphere.panorama,
      caption: window.currentSphere.caption,
      markers: @getPortalsAndMarkers(currentSphere)
    , @defaultPanoramaSettings, @editPanoramaSettings

  _setNextSphereMakers: (sphere) ->
    super
    @portalView.updateSelect()
    @zoomView.resetSliderValue()

  freezeOtherViews: (except) ->
    viewsToFreeze = _.reject @views, (view) ->
      view instanceof except.constructor

    for view in viewsToFreeze
      view.freeze()

  unfreezeOtherViews: (except) ->
    viewsToUnfreeze = _.reject @views, (view) ->
      view instanceof except.constructor

    for view in viewsToUnfreeze
      view.resetViewState()

  resetPageState: =>
    @resetCursor()

    for view in @views
      view.resetViewState()

  handleNewSphere: ->
    @sphereSelectView.renderSpheres()
    @portalView.updateSelect()

  doTransition: ->
    super(arguments...)
    @resetPageState()

  setCursorToPencil: ->
    $('.psv-hud').awesomeCursor('pencil', {
      hotspot: [3, 22]
      outline: 'white'
    })

  resetCursor: ->
    $('.psv-hud').css('cursor', 'move')

  hackThePencil: ->
    $('body').append("<i class='fa fa-pencil' style='width:0px; height:0px; overflow:hidden'>");


# Promises

  onAjaxError: (jqXHR, textStatus, errorThrown) =>
    alert("Looks like that request didn't work... #{textStatus}: #{errorThrown}")


# Constants

  defaultMarkerDimension: <%= Marker::DEFAULT_DIM %>

  editPanoramaSettings:
    anim_speed: '0rpm'

window.EditMemoryApplication = EditMemoryApplication
